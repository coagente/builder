[tool:pytest]
# =============================================================================
# PYTEST CONFIGURATION FOR DESPIECE-BOT
# =============================================================================

# Minimum version
minversion = 7.0

# Test discovery
testpaths = tests
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# Add options
addopts = 
    -ra
    --strict-markers
    --strict-config
    --cov=src/despiece_bot
    --cov-branch
    --cov-report=term-missing:skip-covered
    --cov-report=html
    --cov-report=xml
    --cov-fail-under=80
    --tb=short
    --disable-warnings

# Async support
asyncio_mode = auto

# Custom markers
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    fast: marks tests as fast
    unit: marks tests as unit tests
    integration: marks tests as integration tests
    e2e: marks tests as end-to-end tests
    ai: marks tests that require AI/LLM calls
    gpu: marks tests that require GPU
    database: marks tests that require database
    redis: marks tests that require Redis
    external: marks tests that require external services
    mock: marks tests that use mocking
    security: marks security-related tests
    performance: marks performance tests
    crewai: marks tests specific to CrewAI functionality
    dspy: marks tests specific to DSPy functionality
    lancedb: marks tests specific to LanceDB functionality
    gemini: marks tests that call Gemini API

# Environment variables for testing
env =
    ENVIRONMENT=testing
    DEBUG=false
    LOG_LEVEL=WARNING
    DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_despiece_bot
    REDIS_URL=redis://localhost:6379/15
    LANCEDB_PATH=./test_data/lancedb
    GOOGLE_AI_API_KEY=test_key_placeholder
    SECRET_KEY=test_secret_key_for_testing_only_minimum_32_chars
    CACHE_TTL_SHORT=1
    CACHE_TTL_MEDIUM=1
    CACHE_TTL_LONG=1
    CREWAI_VERBOSE=false
    DSPY_CACHE_DIR=./test_cache/dspy

# Filter warnings
filterwarnings =
    error
    ignore::UserWarning
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    ignore::ResourceWarning
    ignore:.*experimental.*:UserWarning
    ignore:.*beta.*:UserWarning
    ignore::pytest.PytestUnraisableExceptionWarning

# Log configuration
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = tests.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s (%(filename)s:%(lineno)d)
log_file_date_format = %Y-%m-%d %H:%M:%S

# Timeout for tests (in seconds)
timeout = 300
timeout_method = thread

# Test output
console_output_style = progress

# JUnit XML output
junit_suite_name = despiece_bot_tests
junit_logging = system-out
junit_log_passing_tests = false

# Xdist configuration (parallel testing)
# Usage: pytest -n auto
addopts = --dist=worksteal

# Collection configuration
collect_ignore = [
    "setup.py",
    "conftest.py",
    "migrations/",
    ".tox/",
    "build/",
    "dist/",
]

# Test session configuration
# Fail fast - stop on first failure
# addopts = --maxfail=1

# Verbose output for failures
# addopts = -v --tb=long

# Run only failed tests from last run
# addopts = --lf

# Show local variables in tracebacks
# addopts = --tb=long --showlocals 